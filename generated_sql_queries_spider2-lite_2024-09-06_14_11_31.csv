db_id|question|generated_sql_query|gold_sql_query
bigquery-public-data.ga4_obfuscated_sample_ecommerce|How many pseudo users were active in the last 7 days but inactive in the last 2 days as of January 7, 2021?|select count(distinct user_pseudo_id) from `bigquery-public-data`.ga4_obfuscated_sample_ecommerce.events_* where cast(event_date as date) between cast('2021-01-01' as date) and cast('2021-01-07' as date) group by 1 having sum(cast(event_date as date) between cast('2021-01-06' as date) and cast('2021-01-07' as date)) = 0|select count(distinct mdaysusers.user_pseudo_id) as n_day_inactive_users_count from ( select user_pseudo_id from `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*` as t cross join unnest(t.event_params) as event_params where event_params.key = 'engagement_time_msec' and event_params.value.int_value > 0 /* has engaged in last m = 7 days */ and event_timestamp > unix_micros(timestamp_sub(timestamp('2021-01-07 23:59:59'), interval 7 day)) /* include only relevant tables based on the fixed timestamp */ and _table_suffix between '20210101' and '20210107' ) as mdaysusers left join ( select user_pseudo_id from `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*` as t cross join unnest(t.event_params) as event_params where event_params.key = 'engagement_time_msec' and event_params.value.int_value > 0 /* has engaged in last n = 2 days */ and event_timestamp > unix_micros(timestamp_sub(timestamp('2021-01-07 23:59:59'), interval 2 day)) /* include only relevant tables based on the fixed timestamp */ and _table_suffix between '20210105' and '20210107' ) as ndaysusers on mdaysusers.user_pseudo_id = ndaysusers.user_pseudo_id where ndaysusers.user_pseudo_id is null;
bigquery-public-data.google_analytics_sample|Find the top-selling product among customers who bought 'Youtube Men’s Vintage Henley' in July 2017, excluding itself.|with relevantsessions as ( select s.fullvisitorid from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170710 as s inner join s.hits as h on s.date = '20170710' and h.product.productsku = 'youtube men’s vintage henley' ) select p.v2productname, count(*) as product_count from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170710 as s inner join s.hits as h on s.fullvisitorid in ( select fullvisitorid from relevantsessions ) inner join h.product as p on s.date = '20170710' and p.productsku != 'youtube men’s vintage henley' group by 1 order by product_count desc limit 1;|"with get_cus_id as ( select distinct fullvisitorid as henley_customer_id from `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`, unnest(hits) as hits, unnest(hits.product) as product where product.v2productname = ""youtube men's vintage henley"" and product.productrevenue is not null ) select product.v2productname as other_purchased_products from `bigquery-public-data.google_analytics_sample.ga_sessions_201707*` tab_a right join get_cus_id on get_cus_id.henley_customer_id=tab_a.fullvisitorid, unnest(hits) as hits, unnest(hits.product) as product where tab_a.fullvisitorid in ( select * from get_cus_id ) and product.v2productname <> ""youtube men's vintage henley"" and product.productrevenue is not null group by product.v2productname order by sum(product.productquantity) desc limit 1;"
bigquery-public-data.google_analytics_sample|Which traffic source receives the top revenue in 2017 and what is the difference (millions, rounded to two decimal places) between its highest and lowest revenue months?|with monthlyrevenue as ( select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170127 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170710 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170604 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170705 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170611 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170415 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170316 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170729 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170219 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170227 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170629 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170724 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170321 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170305 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170513 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170515 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170605 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170415 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170308 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170125 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170424 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160808 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160820 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161003 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161013 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161113 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161027 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160824 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160916 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161119 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161009 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160910 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160903 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160907 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161012 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160828 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161020 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161102 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161008 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161202 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160909 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161217 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160912 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160918 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160922 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170107 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161203 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160827 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160901 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161005 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161106 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170106 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160915 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161020 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160801 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161021 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170320 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161010 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160914 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160804 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160919 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161125 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160806 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161124 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161101 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161109 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160902 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161027 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170102 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160802 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160822 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160908 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170725 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170727 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161210 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170104 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161104 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170122 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161215 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160805 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160916 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161016 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170602 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161117 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20160910 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161120 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170123 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170407 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170608 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170609 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170302 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170129 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170701 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161106 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170113 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170110 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170112 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170115 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170116 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170108 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170124 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170303 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170309 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20170314 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161029 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161123 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161128 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161108 union all select trafficsource.source as traffic_source, date_trunc(date, month) as month, sum(totals.transactionrevenue) as monthly_revenue from `bigquery-public-data`.google_analytics_sample.ga_sessions_20161114 union all select trafficsource.source|"with monthly_revenue as ( select format_date(""%y%m"", parse_date(""%y%m%d"", date)) as month, trafficsource.source as source, round(sum(totals.totaltransactionrevenue) / 1000000, 2) as revenue from `bigquery-public-data.google_analytics_sample.ga_sessions_2017*` group by 1, 2 ), yearly_revenue as ( select source, sum(revenue) as total_revenue from monthly_revenue group by source ), top_source as ( select source from yearly_revenue order by total_revenue desc limit 1 ), source_monthly_revenue as ( select month, source, revenue from monthly_revenue where source in (select source from top_source) ), revenue_diff as ( select source, round(max(revenue), 2) as max_revenue, round(min(revenue), 2) as min_revenue, round(max(revenue) - min(revenue), 2) as diff_revenue from source_monthly_revenue group by source ) select source, diff_revenue from revenue_diff;"
